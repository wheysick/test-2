<!-- /thank-you.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thank you</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/checkout.css">

  <!-- Ensure the same pixel base used on the main page -->
  <script src="/js/pixel.js" defer></script>
</head>
<body style="max-width:min(92vw,760px);margin:60px auto;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#E9ECF2;background:#0A0C10">
  <h1 style="margin:.2rem 0 1rem;">Thank you!</h1>
  <p>Your order is being prepared.</p>
  <p id="orderLine" style="opacity:.9"></p>
  <p><a href="/" style="color:#98b7ff">Back to site</a></p>

  <script>
    (function(){
      // ——— helpers ———
      function qp(name){
        const m = new RegExp('[?&]'+name+'=([^&#]*)').exec(location.search);
        return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : '';
      }
      function num(x){ const n = parseFloat(x); return Number.isFinite(n) ? n : null; }

      // 1) Prefer server/redirect params
      let value    = num(qp('amount')) ?? num(qp('value'));
      let currency = qp('currency') || 'USD';
      let orderId  = qp('order_id') || qp('order') || qp('txn_id') || '';

      // 2) Fallbacks from your checkout flow (sessionStorage set by checkout.js)
      if (value == null || value <= 0) {
        const v = num(sessionStorage.getItem('coLastTotal'));
        if (v != null) value = v;
      }
      let qty = parseInt(sessionStorage.getItem('coLastQty') || '0', 10);
      let method = sessionStorage.getItem('coLastMethod') || 'card';

      // 3) Fallbacks from pixel-events/localStorage (set on main page)
      if (value == null || value <= 0) {
        const v2 = num(localStorage.getItem('last_value'));
        if (v2 != null) value = v2;
      }
      if (!qty || qty < 1) {
        qty = parseInt(localStorage.getItem('last_qty') || '1', 10);
      }
      const sku = localStorage.getItem('last_sku') || 'BOTTLE';

      // 4) Last-ditch order id
      if (!orderId) {
        orderId = sessionStorage.getItem('coOrderId');
        if (!orderId) {
          orderId = 'T-' + (crypto?.randomUUID ? crypto.randomUUID().slice(0,8).toUpperCase() : (Date.now().toString(36).toUpperCase()));
          sessionStorage.setItem('coOrderId', orderId);
        }
      }

      // Paint UI
      const o = document.getElementById('orderLine');
      if (o) o.textContent = `Order ${orderId} · ${qty} bottle(s) · ${method.toUpperCase()} · $${(value ?? (qty*45)).toFixed(2)}`;

      // Build contents for pixel
      const contents = [{ id: sku, quantity: qty }];
      const params = {
        value: (value != null ? value : qty * 45),
        currency,
        contents,
        content_type: 'product',
        order_id: orderId
      };

      // Strong, stable dedupe guard (no Date.now)
      var guardKey = 'fb_purchase_fired|' + (orderId || (params.value + '|' + qty + '|' + sku));
      if (sessionStorage.getItem(guardKey)) return;
      sessionStorage.setItem(guardKey, '1');

      // Single, canonical fire — prefer trackSingle if pixel id is known
      function fire(params){
        try {
          if (window.fbq) {
            if (window.__FB_PIXEL_ID__) {
              fbq('trackSingle', window.__FB_PIXEL_ID__, 'Purchase', params);
            } else {
              fbq('track', 'Purchase', params);
            }
          }
        } catch(e){}
        // If you also run CAPI server-side, send event_id here and mirror it server-side
        // (left out intentionally since no endpoint is shown in your snippet)
      }

      // Avoid multiple code paths: do not call firePurchase/fbqSafe if present
      fire(params);
    })();
  </script>
</body>
</html>
