<!-- /thank-you.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Thank you</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/checkout.css">
  <script src="/js/pixel.js"></script>
</head>
<body style="max-width:min(92vw,760px);margin:60px auto;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#E9ECF2;background:#0A0C10">
  <h1 style="margin:.2rem 0 1rem;">Thank you!</h1>
  <p>Your order is being prepared.</p>
  <p id="orderLine" style="opacity:.9"></p>
  <p><a href="/" style="color:#98b7ff">Back to site</a></p>

  <script>
    (function(){
      // Read latest totals saved by checkout.js
      const total  = Number(sessionStorage.getItem('coLastTotal') || '0');
      const qty    = Number(sessionStorage.getItem('coLastQty') || '1');
      const method = sessionStorage.getItem('coLastMethod') || 'card';
      let orderId  = sessionStorage.getItem('coOrderId');
      if (!orderId) {
        orderId = 'T-' + (crypto?.randomUUID ? crypto.randomUUID().slice(0,8).toUpperCase() : Date.now());
        sessionStorage.setItem('coOrderId', orderId);
      }
      const contents = [{ id: 'tirzepatide-bundle', quantity: qty }];

      // Paint UI
      const o = document.getElementById('orderLine');
      if (o) o.textContent = `Order ${orderId} · ${qty} bottle(s) · ${method.toUpperCase()} · $${total.toFixed(2)}`;

      // Fire Purchase (browser + server with event_id for dedupe)
      if (typeof firePurchase === 'function') {
        firePurchase({ value: total, currency:'USD', contents, order_id: orderId });
      } else if (typeof fbqSafe === 'function') {
        fbqSafe('Purchase', { value: total, currency:'USD', contents, content_type:'product', order_id: orderId });
      }
    })();
  </script>

  <script>
  (function(){
    if (!window.fbq || !window.__FB_PIXEL_ID__) return;

    function qp(name){
      const m = new RegExp('[?&]'+name+'=([^&#]*)').exec(location.search);
      return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : '';
    }

    // Prefer server/redirect params if you pass them
    let value    = parseFloat(qp('amount')) || parseFloat(qp('value'));
    let currency = qp('currency') || 'USD';
    let orderId  = qp('order_id') || qp('order') || qp('txn_id') || '';

    // Fallback to localStorage (set on the main page)
    if (!Number.isFinite(value) || value <= 0) {
      const v = parseFloat(localStorage.getItem('last_value'));
      if (Number.isFinite(v)) value = v;
    }
    if (!currency)  currency = localStorage.getItem('last_currency') || 'USD';

    const qty = parseInt(localStorage.getItem('last_qty') || '1', 10);
    const sku = localStorage.getItem('last_sku') || 'BOTTLE';

    // Guard so we never double-fire if customer reloads the TY page
    const guardKey = 'fb_purchase_fired_' + (orderId || (value + '_' + Date.now()));
    if (sessionStorage.getItem(guardKey)) return;
    sessionStorage.setItem(guardKey, '1');

    fbq('track', 'Purchase', {
      value: value || (qty * 45),
      currency: currency,
      contents: [{ id: sku, quantity: qty }],
      content_type: 'product',
      order_id: orderId
    });
  })();
</script>

</body>
</html>
